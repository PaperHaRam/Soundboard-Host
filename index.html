<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Soundboard â€“ Host (Verified)</title>

<style>
body {
  background:#0f1115;
  color:#e8ecf3;
  font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
  margin:0; padding:20px;
}
h1 { margin:0 0 10px 0 }
button {
  background:#232939;
  color:#fff;
  border:1px solid #2c3347;
  border-radius:8px;
  padding:10px 14px;
  cursor:pointer;
  font-weight:600;
}
button:hover { border-color:#3b435c }
.small { font-size:12px; color:#8a93a6 }
.row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
.panel {
  background:#171a21;
  border:1px solid #222732;
  border-radius:12px;
  padding:14px;
  margin-top:12px;
}
</style>
</head>

<body>

<h1>ğŸ› Soundboard Host (Debug)</h1>

<div class="panel row">
  <button id="unlockBtn">ğŸ”Š AudioContext í™œì„±í™”</button>
  <button id="makeCodeBtn">ğŸ“¡ ê³µìœ  ì½”ë“œ ìƒì„±</button>
  <span id="code" class="small">â€”</span>
</div>

<div class="panel row">
  <button id="playTest">â–¶ í…ŒìŠ¤íŠ¸ í†¤ (1ì´ˆ)</button>
  <span class="small">ë¦¬ìŠ¤ë„ˆì—ì„œ ì†Œë¦¬ ë“¤ë¦¬ë©´ ìŠ¤íŠ¸ë¦¼ ì •ìƒ</span>
</div>

<div class="panel">
  <div class="small">ìƒíƒœ</div>
  <pre id="log" class="small"></pre>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
/* ================= Audio ================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();

const overallMaster = audioCtx.createGain();
overallMaster.gain.value = 1.0;

/* ğŸ”´ ì‹¤ì œ ìŠ¤í”¼ì»¤ + ìŠ¤íŠ¸ë¦¼ BOTH */
overallMaster.connect(audioCtx.destination);

const shareDest = audioCtx.createMediaStreamDestination();
overallMaster.connect(shareDest);

/* ================= Peer ================= */
let peer = null;
let connections = new Set();

/* ================= UI ================= */
const unlockBtn = document.getElementById('unlockBtn');
const makeCodeBtn = document.getElementById('makeCodeBtn');
const codeEl = document.getElementById('code');
const logEl = document.getElementById('log');

function log(msg) {
  logEl.textContent += msg + "\n";
}

/* ================= Unlock ================= */
unlockBtn.onclick = async () => {
  await audioCtx.resume();
  log("AudioContext state: " + audioCtx.state);
};

/* ================= Share ================= */
function genCode() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s = "";
  for (let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

makeCodeBtn.onclick = () => {
  if (peer) return alert("ì´ë¯¸ ì½”ë“œ ìƒì„±ë¨");

  const code = genCode();
  peer = new Peer(code, {
    debug: 1,
    config: {
      iceServers: [{ urls:"stun:stun.l.google.com:19302" }]
    }
  });

  codeEl.textContent = code;
  log("Peer ìƒì„±: " + code);

  peer.on('open', () => {
    log("Peer open OK");
  });

  peer.on('connection', (conn) => {
    connections.add(conn.peer);
    log("ë¦¬ìŠ¤ë„ˆ ì—°ê²°: " + conn.peer);

    const tracks = shareDest.stream.getAudioTracks();
    log("ğŸ“¡ call ì§ì „ tracks: " + tracks.length);

    peer.call(conn.peer, shareDest.stream);

    conn.on('close', () => {
      connections.delete(conn.peer);
      log("ë¦¬ìŠ¤ë„ˆ ì¢…ë£Œ: " + conn.peer);
    });
  });

  peer.on('error', e => log("Peer ì˜¤ë¥˜: " + e.message));
};

/* ================= Test Tone ================= */
document.getElementById('playTest').onclick = () => {
  if (audioCtx.state !== 'running') {
    alert("ë¨¼ì € AudioContext í™œì„±í™” ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”");
    return;
  }

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.frequency.value = 440;
  gain.gain.value = 0.2;

  osc.connect(gain).connect(overallMaster);
  osc.start();

  log("ğŸ”Š í…ŒìŠ¤íŠ¸ í†¤ ì‹œì‘");

  setTimeout(() => {
    osc.stop();
    osc.disconnect();
    log("ğŸ”‡ í…ŒìŠ¤íŠ¸ í†¤ ì¢…ë£Œ");
  }, 1000);
};
</script>

</body>
</html>
